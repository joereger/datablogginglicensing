
<project name="RegerLicensing" default="QuickBuild" basedir=".">
  <description>
        Builds the licensing app.
  </description>

  <!-- Import properties file -->
  <property file="RegerLicensing.properties"/>
                 

  <!-- Create a buildnumber -->
  <target name="buildnumber" description="Create a build number.">
     <echo message="Generating build number."/>
     <buildnumber/>
  </target>

  <!-- Create a timestamp -->
  <target name="timestamp" description="Create the dirs" depends="buildnumber">
  	 <echo message="Generating timestamp."/>
     <tstamp>
        <format property="build.time" pattern="yyyy-MM-dd-(hh-mm-ssaa)"/>
     </tstamp>
  </target>

  <!-- Import build number file -->
  <property file="build.number"/>

  <!-- Set internal script properties -->
  <property name="tomcat.app.name" value="RegerLicensing"/>
  <property name="builddir" value="${builds.directory}"/>
  <property name="lastbuild" value="${builddir}/lastbuild/${tomcat.app.name}"/>
  <property name="wardir" value="${builddir}/WARs/${tomcat.app.name}"/>
  <property name="javasrc" value="${builddir}/lastbuild/${tomcat.app.name}/WEB-INF/classes"/>
  <property name="sourcedir" value="${source.root.directory}"/>

    <property name="tomcatjarsforclasspath" value="
                ${tomcat.install.directory}/common/lib/jsp-api.jar;
                ${tomcat.install.directory}/common/lib/servlet-api.jar;
                ${tomcat.install.directory}/server/lib/catalina.jar;
                ${tomcat.install.directory}/server/lib/catalina-optional.jar;
                ${tomcat.install.directory}/server/lib/catalina-ant.jar;
                ${tomcat.install.directory}/server/lib/servlets-common.jar;
                ${tomcat.install.directory}/server/lib/servlets-default.jar;
          "/>
          <property name="thirdpartylibs" value="
            ${sourcedir}/WEB-INF/lib/activation.jar;
            ${sourcedir}/WEB-INF/lib/commons-codec-1.2.jar;
            ${sourcedir}/WEB-INF/lib/commons-collections.jar;
            ${sourcedir}/WEB-INF/lib/commons-dbcp-1.2.1.jar;
            ${sourcedir}/WEB-INF/lib/commons-pool-1.2.jar;
            ${sourcedir}/WEB-INF/lib/oscache-2.1.1.jar;
            ${sourcedir}/WEB-INF/lib/proxool-0.8.3.jar;
            ${sourcedir}/WEB-INF/lib/xmlrpc-2.0.jar;
            ${sourcedir}/WEB-INF/lib/xstream-1.0.2.jar;
            ${sourcedir}/WEB-INF/lib/Verisign.jar;
            ${sourcedir}/WEB-INF/lib/regercore.jar;
            ${sourcedir}/WEB-INF/lib/mysql-connector-java-3.1.8-bin.jar;
      "/>



  <!-- First, Delete any files in the lastbuild folder -->
  <target name="cleanuplastbuild" description="Cleans up the last build" depends="timestamp">
    <echo message="Cleaning up lastbuild for: ${tomcat.app.name}"/>
    <delete dir="${lastbuild}"/>
  </target>

  <!-- This target takes all files required for the build and puts them into lastbuild which is basically a temp building location -->
  <!-- This is done so that I can have Vars.java and VarsDev.java, choosing which one to put into the build at buildtime -->
  <target name="movefilestolastbuild" description="Moves files to the lastbuild directory." depends="cleanuplastbuild">
      <copy todir="${lastbuild}">
        <fileset dir="${sourcedir}" excludes="**.*Thumbs.db"/>
      </copy>
  </target>




  <!-- Compile the app-->
   <target name="compile" description="compile the source" depends="movefilestolastbuild">
  	 <echo message="Compiling Java code."/>
       <javac srcdir="${javasrc}" excludes="**.x" debug="on" classpath="${tomcatjarsforclasspath}; ${thirdpartylibs}"/>
   </target>

   
   <!-- Package the app for Dev -->
   <target name="package" description="Create the WAR file" depends="compile">
        <echo message="Packaging ${tomcat.app.name}'s war file."/>
        <delete>
            <fileset dir="." includes="*.war"/>
        </delete>
        <war destfile="${tomcat.app.name}-(bld${build.number})-${build.time}.war" webxml="${lastbuild}/WEB-INF/web.xml">
            <fileset dir="${lastbuild}">
                <exclude name="**/*.java"/>
                <exclude name="**/web.xml"/>
            </fileset>
        </war>
		<copy file="${tomcat.app.name}-(bld${build.number})-${build.time}.war" todir="${builddir}"/>
   </target>

   <target name="packagewithsource" description="Backup source files" depends="package">
        <echo message="Backing up ${tomcat.app.name}'s source."/>
        <jar jarfile="${builddir}/${tomcat.app.name}-(bld${build.number})-${build.time}-src.jar">
            <fileset dir="./">
                <exclude name="builds/**"/>
            </fileset>
        </jar>
   </target>

   


    
    <!-- Dev WAR file builders -->
    <!-- Use to build WAR file to manually deploy. -->
    <!-- It will be called ROOT.war and will be found in the root build directory -->
    <target name="buildWar" description="Builds a war file and does not deploy it." depends="packagewithsource">
        <echo message="Creating licensing.war for ${tomcat.app.name}."/>
        <copy file="${tomcat.app.name}-(bld${build.number})-${build.time}.war" tofile="${wardir}/licensing.war" overwrite="true"/>
		<delete file="${tomcat.app.name}-(bld${build.number})-${build.time}.war"/>
    </target>





    <!-- Create javaDoc -->
    <target name="createJavaDoc" description="Creates javadoc" depends="">
        <echo message="Creating javaDoc for ${tomcat.app.name}."/>
        <delete dir="${builddir}/javaDoc"/>

        <javadoc destdir="${builddir}/javaDoc" author="true" version="true" use="true" windowtitle="Reger.com javaDoc">

            <packageset dir="${sourcedir}/WEB-INF/classes" defaultexcludes="yes">
                <include name="reger/**" />
            </packageset>

            <doctitle><![CDATA[<h1>Reger.com</h1>]]></doctitle>
            <bottom><![CDATA[<i>Copyright &#169; 2005 Reger.com. Confidential and proprietary. All Rights Reserved.</i>]]></bottom>

        </javadoc>

    </target>
	
    

    <target name="QuickBuild" description="Compile the java source and put in Tomcat working directory">
  	 	<echo message="Compiling Java code."/>
     	<copy todir="${lastbuild}" >
            <fileset dir="${sourcedir}" excludes="**/Thumbs.db"/>
        </copy>

     	<javac srcdir="${javasrc}" destdir="${quickbuild.compiled.destination.directory}" excludes="**.x" debug="on" />
		<copy todir="${quickbuild.tomcat.root.directory}">
			<fileset dir="${lastbuild}">
			</fileset>
		</copy>
		<!--
		<ant antfile="TomcatDeploy.xml" target="reloadApp" inheritAll="true"/>
		-->
	</target>

    

</project>
