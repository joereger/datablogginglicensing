<%@ page import="reger.core.db.Db,
                 reger.core.licensing.License,
                 java.util.Hashtable,
                 java.util.Iterator,
                 java.util.Map,
                 reger.licensingapi.LicenseDb,
                 reger.licensingapi.RegerLicensingApiServer"%>
<%@ page import="java.util.HashMap" %>

<%
String pathToAppRoot = "";
%>

<%@ include file="globalheader.jsp" %>

<%
/*----------------------------------------------------*/
/*                  Main Body                         */
        StringBuffer mb = new StringBuffer();
/*----------------------------------------------------*/

//Start with a blank license
License lic = new License(null, "");

//Load a license, if there is one
LicenseDb licDb = new LicenseDb(0);
if (request.getParameter("licenseid")!=null && reger.core.Util.isinteger(request.getParameter("licenseid"))){
    licDb = new LicenseDb(Integer.parseInt(request.getParameter("licenseid")));
}

//If it's a save call
if (request.getParameter("action")!=null && request.getParameter("action").equals("email")){
    if (licDb.getLicenseid()>0){
        reger.core.EmailSend.sendMail("server@reger.com", request.getParameter("emailaddress"), "datablogging License Key", licDb.getEncryptedlicense());
    }
}


//If it's a save call
if (request.getParameter("action")!=null && request.getParameter("action").equals("save")){
    //Populate from the request
    licDb.populate(request);

    if (licDb.getLicenseid()<=0){
        //Get the properties from the screen
        HashMap inProps = new HashMap();
        for (Iterator i=License.getAllPropTypes().entrySet().iterator(); i.hasNext(); ) {
            Map.Entry e = (Map.Entry) i.next();
            //e.getKey()
            //e.getValue()
            if (request.getParameter(String.valueOf(e.getKey()))!=null && !request.getParameter(String.valueOf(e.getKey())).equals("")){
                if (request.getParameter("include-"+String.valueOf(e.getKey()))!=null && request.getParameter("include-"+String.valueOf(e.getKey())).equals("1")){
                    inProps.put(e.getKey(), request.getParameter(String.valueOf(e.getKey())));
                }
            }
        }
        
        //Create the license
        lic = new License(inProps);

        //Call api
        RegerLicensingApiServer server = new RegerLicensingApiServer();
        Hashtable result = server.createLicense(lic.getEncryptedLicense(), licDb);

        //If it's successful
        if (result.containsKey("successful") && String.valueOf(result.get("successful")).equals("true")){
            //Get the encrypted license
            String encryptedLicense = String.valueOf(result.get("encryptedlicense"));
            License tmpLic = new License(null, encryptedLicense);
            //If there's a valid licenseid
            if (tmpLic.getProperty(License.PROPSTRINGLICENSEID)!=null && reger.core.Util.isinteger(tmpLic.getProperty(License.PROPSTRINGLICENSEID))){
                licDb = new LicenseDb(Integer.parseInt(tmpLic.getProperty(License.PROPSTRINGLICENSEID)));
            }
        //Else it's unsuccessful
        } else {
            mb.append("<font face=arial size=+3 color=#ff0000>Error: " + result.get("error") + "</font><br>");
        }

    } else {
        //Save to the database... ignore any change to the license and adjust the billing info
        licDb.save();
    }

}


mb.append("<table cellpadding=3 cellspacing=1 width=100% border=0>");
mb.append("<form action=createlicense.log method=post>");
mb.append("<input type=hidden name=action value='save'>");
mb.append("<input type=hidden name=licenseid value='"+licDb.getLicenseid()+"'>");

if (licDb.getLicenseid()<=0){
    for (Iterator i=License.getAllPropTypes().entrySet().iterator(); i.hasNext(); ) {
        Map.Entry e = (Map.Entry) i.next();
        //e.getKey()
        //e.getValue()
        mb.append("<tr>");
        mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>"+e.getKey()+"</strong></font></td>");
        mb.append("<td bgcolor=#e6e6e6>");
        mb.append("<input type=text name='"+String.valueOf(e.getKey())+"' size=50 maxlength=255 value=\'"+lic.getProperty(String.valueOf(e.getKey()))+"\'>");
        mb.append("<input type=checkbox name='include-"+String.valueOf(e.getKey())+"' value='1'> Include?");
        mb.append("</td>");
        mb.append("</tr>");
    }
} else {
    License tmpLic = new License(null, licDb.getEncryptedlicense());
    mb.append("<tr>");
    mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>Encrypted License</strong></font></td>");
    mb.append("<td bgcolor=#e6e6e6>");
    mb.append("<textarea wrap=virtual rows=6 cols=60 style=\"width: 100%;\">");
    mb.append(tmpLic.getEncryptedLicense());
    mb.append("</textarea>");
    mb.append("</td>");
    mb.append("</tr>");

    String decryptedLicense = licDb.getDecryptedlicense();
    String[] nameValuePairs = decryptedLicense.split("&");
    StringBuffer nvp = new StringBuffer();
    for (int j = 0; j < nameValuePairs.length; j++) {
        String nameValuePair = nameValuePairs[j];
        nvp.append(nameValuePair + "<br>");
    }

    mb.append("<tr>");
    mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>Decrypted License</strong></font></td>");
    mb.append("<td bgcolor=#e6e6e6>");
    mb.append("<font face=arial size=-1>"+ nvp + "</font>");
    mb.append("</td>");
    mb.append("</tr>");

}

mb.append("<tr>");
mb.append("<td bgcolor=#ffffff><font face=arial size=-1>&nbsp;</font></td>");
mb.append("<td bgcolor=#ffffff></td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>isactive (0/1)</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='isactive' size=50 maxlength=255 value='"+reger.core.Util.booleanAsSQLText(licDb.isIsactive())+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>isbillingok (0/1)</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='isbillingok' size=50 maxlength=255 value='"+reger.core.Util.booleanAsSQLText(licDb.isIsbillingok())+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>name</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='name' size=50 maxlength=255 value='"+licDb.getName()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>address1</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='address1' size=50 maxlength=255 value='"+licDb.getAddress1()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>address2</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='address2' size=50 maxlength=255 value='"+licDb.getAddress2()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>city</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='city' size=50 maxlength=255 value='"+licDb.getCity()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>state</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='state' size=50 maxlength=255 value='"+licDb.getState()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>zip</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='zip' size=50 maxlength=255 value='"+licDb.getZip()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>country</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='country' size=50 maxlength=255 value='"+licDb.getCountry()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>phone</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='phone' size=50 maxlength=255 value='"+licDb.getPhone()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>email</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='email' size=50 maxlength=255 value='"+licDb.getEmail()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>ccnum</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='ccnum' size=50 maxlength=255 value='"+licDb.getCcnum()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>ccexpmonth</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='ccexpmonth' size=50 maxlength=255 value='"+licDb.getCcexpmonth()+"'>");
mb.append("</td>");
mb.append("</tr>");

mb.append("<tr>");
mb.append("<td bgcolor=#cccccc><font face=arial size=-1><strong>ccexpyear</strong></font></td>");
mb.append("<td bgcolor=#e6e6e6>");
mb.append("<input type=text name='ccexpyear' size=50 maxlength=255 value='"+licDb.getCcexpyear()+"'>");
mb.append("</td>");
mb.append("</tr>");



if (licDb.getLicenseid()<=0){
    mb.append("<tr>");
    mb.append("<td bgcolor=#ffffff><font face=arial size=-1>&nbsp;</font></td>");
    mb.append("<td bgcolor=#ffffff><input type=submit value='Create License'></td>");
    mb.append("</tr>");
} else {
    mb.append("<tr>");
    mb.append("<td bgcolor=#ffffff><font face=arial size=-1>&nbsp;</font></td>");
    mb.append("<td bgcolor=#ffffff><input type=submit value='Edit License'></td>");
    mb.append("</tr>");
}

mb.append("</table>");



mb.append("<form action=createlicense.log method=post>");
mb.append("<input type=hidden name=action value='email'>");
mb.append("<input type=hidden name=licenseid value='"+licDb.getLicenseid()+"'>");
mb.append("<input type=text name=emailaddress value=''>");
mb.append("<input type=submit value='Send License by Email'>");
mb.append("</form>");



if (licDb.getLicenseid()>0){
    mb.append("<table cellpadding=5 cellspacing=2 width=100% border=1>");

    mb.append("<tr>");
    mb.append("<td bgcolor=#cccccc valign=top align=left>");
    mb.append("<font face=arial size=-1>");
    mb.append("Transactionid");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td bgcolor=#cccccc valign=top align=left>");
    mb.append("<font face=arial size=-1>");
    mb.append("Licenseid");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td bgcolor=#cccccc valign=top align=left>");
    mb.append("<font face=arial size=-1>");
    mb.append("Date");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td bgcolor=#cccccc valign=top align=left>");
    mb.append("<font face=arial size=-1>");
    mb.append("Sent");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("<td bgcolor=#cccccc valign=top align=left>");
    mb.append("<font face=arial size=-1>");
    mb.append("Recieved");
    mb.append("</font>");
    mb.append("</td>");
    mb.append("</tr>");

    //-----------------------------------
    //-----------------------------------
        String[][] rs = reger.core.db.Db.RunSQL("SELECT transactionid, transactiondatetime, sentstring, resultstring, licenseid FROM transaction WHERE licenseid='"+licDb.getLicenseid()+"' ORDER BY transactionid DESC");
    //-----------------------------------
    //-----------------------------------
        if (rs!=null && rs.length>0){
            for(int i=0; i<rs.length; i++){
                mb.append("<tr>");


                //Transactionid
                mb.append("<td valign=top align=left>");
                mb.append("<font face=arial size=-1>");
                mb.append(rs[i][0]);
                mb.append("</font>");
                mb.append("</td>");

                //Licenseid
                mb.append("<td valign=top align=left>");
                mb.append("<font face=arial size=-1>");
                mb.append("<a href='createlicense.log?licenseid="+rs[i][4]+"'>");
                mb.append(rs[i][4]);
                mb.append("</a>");
                mb.append("</font>");
                mb.append("</td>");

                //Datetime
                mb.append("<td valign=top align=left>");
                mb.append("<font face=arial size=-1>");
                mb.append(reger.core.TimeUtils.dateformatcompactwithtime(reger.core.TimeUtils.dbstringtocalendar(rs[i][1])));
                mb.append("</font>");
                mb.append("</td>");

                //Sent
                mb.append("<td valign=top align=left>");
                mb.append("<font face=arial size=-1>");
                mb.append("<textarea rows=5 cols=40>");
                mb.append(rs[i][2]);
                mb.append("</textarea>");
                mb.append("</font>");
                mb.append("</td>");

                //Received
                mb.append("<td valign=top align=left>");
                mb.append("<font face=arial size=-1>");
                mb.append("<textarea rows=5 cols=40>");
                mb.append(rs[i][3]);
                mb.append("</textarea>");
                mb.append("</font>");
                mb.append("</td>");

                mb.append("</tr>");
            }
        } else {
            mb.append("<td valign=top align=left colspan=5>");
            mb.append("<font face=arial size=-1>");
            mb.append("No transactions found.");
            mb.append("</font>");
            mb.append("</td>");
            mb.append("</tr>");
        }


    mb.append("</table>");
}





%>


<%@ include file="globalfooter.jsp" %>

